<!DOCTYPE html>
<html>
<script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular.min.js"></script>
<script src="https://rawgit.com/allenhwkim/angularjs-google-maps/master/build/scripts/ng-map.min.js"></script>
<body>

<style>
#container {
    width: 100%;
    max-width: 700px;
    margin: 2em auto;
}
.map {
    width: 100%;
    height: 350px;
}
.cols {
    -moz-column-count:3;
    -moz-column-gap: 3%;
    -moz-column-width: 30%;
    -webkit-column-count:3;
    -webkit-column-gap: 3%;
    -webkit-column-width: 30%;
    column-count: 3;
    column-gap: 3%;
    column-width: 30%;
}
.box {
    margin-bottom: 20px;
    overflow: scroll;
}
.box.one {
    height: 200px;
    background-color: #d77575;
}
.box.two {
    height: 300px;
    background-color: #dcbc4c;
}
.box.three {
    background-color: #a3ca3b;
    height: 400px;
}
.box.four {
    background-color: #3daee3;
    height: 500px;
}
.box.five {
    background-color: #bb8ed8;
    height: 600px;
}
.box.six {
    background-color: #baafb1;
    height: 200px;
}
</style>

<script>
var app = angular.module('pogo', ['ngMap'])
app.service('pogo', function() {
    this.getInventory = function (x) {
        return x.toString(16);
    }
})
app.controller("homeCtrl", function($scope, $interval, $http) {
    $scope.updateInventory = function updateInventory() {
        $http.get('/api/inventory').then(function successCb(response) {
            console.log('inventory', response)
            $scope.inventory = response.data
        }, function errorCb(response){
            console.error(response)
        })
    }

    $scope.isPokemon = function(item){
        if (item.inventory_item_data.pokemon_data) {
            if ((item.inventory_item_data.pokemon_data.pokemon_id || 0) > 0) {
              return true
            }
        }
        return false
    }

    $http.get('/api/pokemon_names').then(function successCb(response) {
        console.log('names', response)
        $scope.names = response.data
        $scope.updateInventory()
    }, function errorCb(response){
        console.error(response)
    })

    $http.get('/api/player').then(function successCb(response) {
        console.log('player', response)
        $scope.player = response.data
    }, function errorCb(response){
        console.error(response)
    })

    $scope.updateNearby = function(){
        $http.get('/api/location').then(function successCb(response) {
            console.log('location', response)
            $scope.location = response.data
        }, function errorCb(response){
            console.error(response)
        })

        $http.get('/api/nearby').then(function successCb(response) {
            console.log('nearby', response)
            var cells = response.data
            $scope.nearby = response.data

            var nearby_forts = []
            var nearby_pokemons = []
            if (cells && cells.length > 0) {
                cells.forEach(function processCell(cell, i) {
                    if (cell.catchable_pokemons && cell.catchable_pokemons.length > 0) {
                        cell.catchable_pokemons.forEach(function processPoint(point, j) {
                            nearby_pokemons.push({
                                lat: point.latitude,
                                lng: point.longitude,
                                icon: 'resources/pokemons/' + point.pokemon_id +'.png',
                                expiration: point.expiration_timestamp_ms
                            })
                        })
                    }
                })
                $scope.nearby_forts = nearby_forts
                $scope.nearby_pokemons = nearby_pokemons
                console.info('nearby_pokemons', nearby_pokemons)
            }
        }, function errorCb(response){
            console.error(response)
        })
    }

    $scope.updateNearby()
    
    $scope.autoUpdate = true
    $interval(function() {
        if ($scope.autoUpdate == true) {
            $scope.updateNearby()
        }
    }, 2000);
});
</script>

<div id="container" ng-app="pogo" ng-controller="homeCtrl">
    <div>
        <h3>Your location <small>(<a href="#" ng-click="updateNearby()">update</a>)</small></h3>
        <ng-map center="[{{location.lat}}, {{location.lng}}]" class="map">
            <marker position="{{point.lat}},{{point.lng}}" icon="{{point.icon}}" ng-repeat="point in nearby_forts"></marker>
            <marker position="{{point.lat}},{{point.lng}}" icon="{{point.icon}}" ng-repeat="point in nearby_pokemons"></marker>
            <marker position="{{location.lat}},{{location.lng}}" icon="{{point.icon}}"></marker>
        </ng-map>
    </div>
    <div class="cols">
        <div class="box one">
            <h3>{{player.username}}</h3>
            <ul>
                <li>Location: </li>
            </ul>
        </div>
        <div class="box two">
            <h3>Your Pokemons <small>(<a href="#" ng-click="updateInventory()">update</a>)</small></h3>
            <ul>
                <li ng-repeat="item in inventory | orderBy:'-inventory_item_data.pokemon_data.cp' | filter:isPokemon:item.inventory_item_data.pokemon_data.pokemon_id">
                {{names[item.inventory_item_data.pokemon_data.pokemon_id]}} (CP:{{item.inventory_item_data.pokemon_data.cp}})
                </li>
            </ul>
        </div>
        <!--<div class="box one"></div>-->
        <!--<div class="box three"></div>-->
        <!--<div class="box two"></div>-->
        <!--<div class="box five"></div>-->
        <!--<div class="box one"></div>-->
        <!--<div class="box two"></div>-->
        <!--<div class="box six"></div>-->
        <!--<div class="box three"></div>-->
        <!--<div class="box two"></div>-->
    </div>
</div>
</body>
</html>

